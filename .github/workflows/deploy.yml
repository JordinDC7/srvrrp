name: Deploy to Physgun

on:
  push:
    branches:
      - main

concurrency:
  group: physgun-prod-deploy
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to Game Server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install lftp
        run: sudo apt-get update -qq && sudo apt-get install -y -qq lftp

      - name: Deploy changed files via SFTP
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PASS: ${{ secrets.SFTP_PASS }}
          REMOTE_DIR: ${{ secrets.SFTP_REMOTE_DIR }}
        shell: bash
        run: |
          set -euo pipefail

          BEFORE="${{ github.event.before }}"

          # Files that should NEVER be deployed or deleted (managed via Physgun)
          PROTECTED_FILES="cfg/server.cfg"

          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            echo "=== Initial deploy - uploading all tracked files ==="
            CHANGED=$(find garrysmod/ -type f)
            DELETED=""
          else
            echo "=== Incremental deploy ==="
            CHANGED=$(git diff --name-only --diff-filter=ACMR "$BEFORE" "${{ github.sha }}" -- garrysmod/ || true)
            DELETED=$(git diff --name-only --diff-filter=D "$BEFORE" "${{ github.sha }}" -- garrysmod/ || true)
          fi

          if [ -z "$CHANGED" ] && [ -z "$DELETED" ]; then
            echo "No files changed in garrysmod/, nothing to deploy."
            exit 0
          fi

          # Filter out protected files
          filter_protected() {
            local input="$1"
            local filtered=""
            while IFS= read -r file; do
              [ -z "$file" ] && continue
              local rel="${file#garrysmod/}"
              local skip=false
              for pf in $PROTECTED_FILES; do
                if [ "$rel" = "$pf" ]; then
                  echo "PROTECTED (skipping): $file" >&2
                  skip=true
                  break
                fi
              done
              if [ "$skip" = "false" ]; then
                filtered="$filtered$file"$'\n'
              fi
            done <<< "$input"
            echo "$filtered"
          }

          CHANGED=$(filter_protected "$CHANGED")
          DELETED=$(filter_protected "$DELETED")

          # Build lftp script file (avoids quoting issues)
          SCRIPT_FILE=$(mktemp /tmp/lftp_script.XXXXXX)

          {
            echo "set sftp:auto-confirm yes"
            echo "set net:max-retries 3"
            echo "set net:reconnect-interval-base 5"
            echo "open -u $SFTP_USER,$SFTP_PASS sftp://$SFTP_HOST:$SFTP_PORT"

            # Deletes first
            if [ -n "$DELETED" ]; then
              while IFS= read -r file; do
                [ -z "$file" ] && continue
                rel="${file#garrysmod/}"
                [ -z "$rel" ] && continue
                echo "rm -f $REMOTE_DIR$rel"
              done <<< "$DELETED"
            fi

            # Uploads
            if [ -n "$CHANGED" ]; then
              while IFS= read -r file; do
                [ -z "$file" ] && continue
                rel="${file#garrysmod/}"
                [ -z "$rel" ] && continue
                remote_dir=$(dirname "$REMOTE_DIR$rel")
                echo "mkdir -p $remote_dir"
                echo "put $file -o $REMOTE_DIR$rel"
              done <<< "$CHANGED"
            fi

            echo "bye"
          } > "$SCRIPT_FILE"

          # Log what we're deploying (mask password)
          echo "=== Deploy manifest ==="
          grep -c "^put " "$SCRIPT_FILE" | xargs -I{} echo "Files to upload: {}"
          grep -c "^rm " "$SCRIPT_FILE" 2>/dev/null | xargs -I{} echo "Files to delete: {}" || true
          grep "^put " "$SCRIPT_FILE" | sed "s|put |  UPLOAD: |; s| -o | -> |" || true

          echo "=== Executing lftp ==="
          lftp -f "$SCRIPT_FILE"

          rm -f "$SCRIPT_FILE"
          echo "=== Deploy complete ==="
